<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
  <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='images/favicon.jpeg') }}">
    <!-- Link Bootstrap CSS and JS -->
     <link href="../static/files/css/bootstrap.min.css" rel="stylesheet">
      <script src="../static/files/js/bootstrap.bundle.min.js"></script>
</head>
<body>
     <div class="container-fluid">
     <!-- Include Navbar -->
         {% include 'navbar.html' %}
          <section class="row">
               <div class="col-md-4">
	       <!-- product variable holds the Current Product, This comes from /single_item route in app.py  -->
               <!-- product variable is indexed from 0  - 5  to access specific product details
               product[1] is product name, product[5] represent product image etc..  -->
                      <img src="{{ image_url(product[7]) }}" alt="" width="300" height="300"
                      class="img-thumbnail shadow p-4"><br><br>
                      <h3>{{ product[1] }}</h3>
               </div>

              <div class="col-md-8">
                     <p class="text-muted">{{ product[6] }}</p>
                     <h4 class="text-danger">KES {{ product[4] }}</h4>
                     {% if review_count and review_count > 0 %}
                     <div class="d-flex align-items-center gap-2 mb-2">
                       <span class="text-warning">
                         {% for i in range(1, 6) %}
                           {% if i <= avg_rating_int %}&#9733;{% else %}&#9734;{% endif %}
                         {% endfor %}
                       </span>
                       <span class="text-muted small">{{ avg_rating }}/5</span>
                       <span class="text-muted small">({{ review_count }} reviews)</span>
                     </div>
                     {% else %}
                     <div class="text-muted small mb-2">No reviews yet.</div>
                     {% endif %}
                     {% if product[5] is not none and product[5]|int <= 5 %}
                     <div class="text-danger small mb-2">Low stock: {{ product[5] }} left</div>
                     {% endif %}
                     <b class="text-danger">Category: {{ product[2] }}</b> <br>

                     <form method="POST" action="/add_to_cart/{{ product[0] }}" class="d-flex align-items-center gap-2">
                   <input type="number" name="qty" value="1" min="1" class="form-control" style="width:120px;">
                 <button class="btn btn-success">Add to Cart</button>
                 </form>

                     
                     <br>

      <section class="row">
	  <div class="col-md-6">
	      {% if request.args.get('err') == 'location' %}
        <div class="alert alert-danger py-2">Please enter delivery location.</div>
          {% endif %}

 <form method="POST" action="{{ url_for('pay_on_delivery') }}" class="mt-3">
  <input type="hidden" name="product_id" value="{{ product[0] }}">

  <label class="form-label">Quantity</label>
  <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:140px;" required>

  <label class="form-label mt-2">Delivery Location</label>
  <input type="text" name="location" class="form-control" placeholder="e.g., Nairobi CBD, OTC stage..." required>

  <button type="submit" class="btn btn-success mt-3">
    Pay on Delivery (WhatsApp)
  </button>
</form>

	  </div>
	</section>
        <section class="row mt-4">
          <div class="col-md-10">
            <h4>Ratings &amp; Reviews</h4>

            {% if request.args.get('review') == 'ok' %}
              <div class="alert alert-success py-2">Thanks! Your review has been submitted.</div>
            {% elif request.args.get('review') == 'error' %}
              <div class="alert alert-danger py-2">Please provide a rating and comment.</div>
            {% endif %}

            {% if session.get('key') %}
            <form method="POST" action="/product/{{ product[0] }}/review" class="card p-3 mb-3">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Rating</label>
                  <select name="rating" class="form-select" required>
                    <option value="">Select</option>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Great</option>
                    <option value="3">3 - Good</option>
                    <option value="2">2 - Fair</option>
                    <option value="1">1 - Poor</option>
                  </select>
                </div>
                <div class="col-md-7">
                  <label class="form-label">Comment</label>
                  <input type="text" name="comment" class="form-control" maxlength="500" required>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-primary w-100" type="submit">Submit</button>
                </div>
              </div>
            </form>
            {% else %}
            <div class="alert alert-info py-2">Please sign in to leave a review.</div>
            <a class="btn btn-outline-primary" href="/signin">Sign In</a>
            {% endif %}
            {% if reviews and reviews|length > 0 %}
              {% for r in reviews %}
              <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>{{ r[0] }}</strong>
                  <span class="text-muted small">{{ r[3] }}</span>
                </div>
                <div class="text-warning small mb-1">
                  {% for i in range(1, 6) %}
                    {% if i <= (r[1] or 0) %}&#9733;{% else %}&#9734;{% endif %}
                  {% endfor %}
                  {% if r[4] %}
                  {% endif %}
                </div>
                <div>{{ r[2] }}</div>
              </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">No reviews yet. Be the first to review this product.</div>
            {% endif %}
          </div>
        </section>


              </div>
     </div>

     {% include 'footer.html' %}



</body>
</html>
